<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>VisionFit</title>

<!-- ğŸ”¥ PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">

<style>
body{font-family: Arial;}
.dark{background:#111;color:white;}
#content{line-height:1.7;}
#content *{font-size:inherit !important;}
</style>
</head>

<body>

<h1>VisionFit</h1>
<p>Lee cualquier web con mÃ¡xima comodidad visual</p>

<form id="readerForm">
  <input id="url" placeholder="Ej: marca, elpais..." />
  <button type="submit">Abrir lector</button>
</form>

<br>

<button onclick="increaseFont()">A+</button>
<button onclick="decreaseFont()">A-</button>
<button onclick="toggleDark()">ğŸŒ™</button>
<button onclick="leerTexto()">ğŸ”Š Leer</button>
<button onclick="pararLectura()">â¹ Parar</button>
<button onclick="resumen()">ğŸ§  Resumen fÃ¡cil</button>
<button onclick="volver()">â¬… Volver</button>
<button onclick="inicio()">ğŸ  Inicio</button>
<button onclick="guardarFavorito()">â­ Guardar</button>
<button onclick="verFavoritos()">ğŸ“š Favoritos</button>

<hr>

<div id="content"></div>

<hr>

<h2>Registro VisionFit</h2>
<input id="name" placeholder="Nombre"><br><br>
<input id="email" placeholder="Email"><br><br>
<input id="password" placeholder="ContraseÃ±a" type="password"><br><br>
<button onclick="register()">Registrarse</button>

<script>
let fontSize = 20;
let historial = [];
let currentUrl = "";

// ğŸ”¥ LECTOR
document.getElementById("readerForm").addEventListener("submit", e=>{
  e.preventDefault();
  openReader();
});

async function openReader(){
  let url = document.getElementById("url").value;

  currentUrl = url;
  historial.push(url);

  const res = await fetch(`/api/reader?url=${encodeURIComponent(url)}`);
  const html = await res.text();

  document.getElementById("content").innerHTML = html;
}

// ğŸ”¥ navegaciÃ³n interna
document.addEventListener("click",function(e){
  const link=e.target.closest("a");
  if(!link) return;

  const href=link.getAttribute("href");
  if(!href) return;

  if(href.startsWith("#")) return;

  e.preventDefault();
  openReaderFromLink(href);
});

async function openReaderFromLink(url){
  currentUrl=url;
  historial.push(url);

  const res=await fetch(`/api/reader?url=${encodeURIComponent(url)}`);
  const html=await res.text();

  document.getElementById("content").innerHTML=html;
}

// ğŸ”¥ volver
async function volver(){
  if(historial.length<=1) return;
  historial.pop();
  openReaderFromLink(historial[historial.length-1]);
}

function inicio(){
  document.getElementById("content").innerHTML="";
  historial=[];
}

// â­ favoritos
async function guardarFavorito(){
  const email = document.getElementById("email").value;
  if(!email) return alert("Introduce tu email");

  const title = document.querySelector("h1")?.innerText || currentUrl;

  await fetch("/api/favorites",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({url:currentUrl,title,email})
  });

  alert("Guardado â­");
}

async function verFavoritos(){
  const email = document.getElementById("email").value;
  if(!email) return alert("Introduce tu email");

  const res = await fetch(`/api/favorites?email=${encodeURIComponent(email)}`);
  const favs = await res.json();

  let html="<h2>Favoritos</h2>";

  favs.forEach(f=>{
    html+=`<p><a href="${f.url}">${f.title}</a></p>`;
  });

  document.getElementById("content").innerHTML=html;
}

// ğŸ”Š voz
function leerTexto(){
  const texto=document.getElementById("content").innerText;
  speechSynthesis.cancel();
  speechSynthesis.speak(new SpeechSynthesisUtterance(texto));
}

function pararLectura(){
  speechSynthesis.cancel();
}

// ğŸ¤– IA resumen
async function resumen(){
  const texto=document.getElementById("content").innerText;

  const res=await fetch("/api/resumen-ia",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({texto})
  });

  const data=await res.json();
  document.getElementById("content").innerHTML=data.resumen;
}

// ğŸ‘¤ registro
async function register(){
  const name=document.getElementById("name").value;
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;

  await fetch("/api/users/register",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name,email,password})
  });

  alert("Usuario registrado");
}

// ğŸ”¥ SERVICE WORKER (PWA)
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js")
    .then(()=>console.log("Service Worker OK"));
}
</script>

</body>
</html>